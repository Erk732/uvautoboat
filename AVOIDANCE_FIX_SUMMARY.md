# é¿éšœåä¸ç»§ç»­èµ°é—®é¢˜ - ä¿®å¤æ€»ç»“

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### é—®é¢˜åˆ†æ
```
ç°è±¡ï¼šèˆ¹èƒ½é¿å¼€éšœç¢ç‰©ï¼Œä½†é¿éšœåä¸ç»§ç»­æœå‘ç›®æ ‡èµ°

æ ¹æœ¬åŸå› ï¼š
  full_clear_distance: 60.0 è®¾ç½®å¤ªå¤§
  â”œâ”€ æ¿€å…‰é›·è¾¾æœ€å¤§èŒƒå›´: ~30-35m
  â”œâ”€ é¿éšœæ¨¡å¼é€€å‡ºéœ€è¦: å‰åå·¦å³éƒ½ > 60m
  â”œâ”€ å®é™…æ¿€å…‰æ•°æ®: æœ€å¤š ~30m
  â””â”€ ç»“æœ: é¿éšœæ¨¡å¼æ°¸è¿œæ— æ³•é€€å‡º âŒ

é¿éšœæ¨¡å¼å¡ä½åçš„è¡¨ç°ï¼š
  â”œâ”€ æ¨åŠ›è¢«å¼ºåˆ¶å‰Šå¼±åˆ° 20% (line 938-941)
  â”œâ”€ èˆ¹è •åŠ¨ï¼Œçœ‹èµ·æ¥"ä¸èµ°"
  â”œâ”€ æåæ ‡ç›´æ–¹å›¾å¼ºåˆ¶è½¬å‘ï¼Œè¦†ç›–ç›®æ ‡å¯¼èˆª
  â””â”€ ç”¨æˆ·çœ‹åˆ°: é¿éšœåèˆ¹åœæ­¢æˆ–éšæ„æ¼‚ç§»
```

## ğŸ”§ å·²åº”ç”¨çš„ä¿®å¤

### ä¿®æ”¹ 1ï¼šLaunch å‚æ•°è°ƒæ•´

**æ–‡ä»¶ï¼š** `control/launch/all_in_one_bringup.launch.py`

**æ”¹åŠ¨ï¼š**
```python
# ç¬¬ 81 è¡Œ

OLD:  'full_clear_distance': 60.0,       # âŒ å¯¼è‡´é¿éšœæ¨¡å¼å¡ä½
NEW:  'full_clear_distance': 20.0,       # âœ… åŒ¹é…æ¿€å…‰é›·è¾¾èŒƒå›´
```

**åŸç†ï¼š**
```
æ¿€å…‰é›·è¾¾æ‰«æèŒƒå›´     : 0-30m
æ–°é˜ˆå€¼è®¾ç½®          : 20.0m
é€€å‡ºé¿éšœçš„æ¡ä»¶      : å‰åå·¦å³éƒ½ > 20m

ç°åœ¨å¯èƒ½çš„æ¿€å…‰æ•°æ®ï¼š
- å‰æ–¹: 25m (æ— éšœç¢) âœ…
- å·¦æ–¹: 30m (æ‰«æèŒƒå›´) âœ…  
- å³æ–¹: 30m (æ‰«æèŒƒå›´) âœ…

åˆ¤æ–­: 25 >= 20, 30 >= 20, 30 >= 20 â†’ force_avoid_active = False âœ…
ç»“æœ: é¿éšœæ¨¡å¼æ­£å¸¸é€€å‡ºï¼æ¨åŠ›æ¢å¤åˆ°æ­£å¸¸å€¼ï¼
```

---

## ğŸ“‹ æµ‹è¯•æ­¥éª¤ï¼ˆæŒ‰é¡ºåºï¼‰

### ç¬¬ 1 æ­¥ï¼šç¼–è¯‘ç³»ç»Ÿï¼ˆ2åˆ†é’Ÿï¼‰

```bash
cd /home/bot/yinli_ws

# ç¼–è¯‘
colcon build --packages-select control

# æ£€æŸ¥æ˜¯å¦æˆåŠŸ
echo $?  # åº”è¯¥è¾“å‡º 0ï¼ˆæˆåŠŸï¼‰
```

### ç¬¬ 2 æ­¥ï¼šå¯åŠ¨ç³»ç»Ÿï¼ˆç»ˆç«¯1ï¼‰

```bash
ros2 launch control all_in_one_bringup.launch.py

# åº”è¯¥çœ‹åˆ°çš„æ—¥å¿—ï¼š
# [gps_imu_pose]: Node launched
# [pose_filter]: Node launched
# [all_in_one_stack]: Node launched
# [all_in_one_stack]: Node started, awaiting goal...
```

### ç¬¬ 3 æ­¥ï¼šéªŒè¯èŠ‚ç‚¹ï¼ˆç»ˆç«¯2ï¼‰

```bash
ros2 node list

# åº”è¯¥çœ‹åˆ°ï¼š
/gps_imu_pose
/pose_filter
/all_in_one_stack
```

### ç¬¬ 4 æ­¥ï¼šéªŒè¯å‚æ•°å·²æ›´æ–°ï¼ˆç»ˆç«¯2ï¼‰

```bash
ros2 param get /all_in_one_stack full_clear_distance

# åº”è¯¥è¾“å‡ºï¼š
# Float value is: 20.0
```

### ç¬¬ 5 æ­¥ï¼šè¿è¡Œé¿éšœæµ‹è¯•ï¼ˆç»ˆç«¯2ï¼‰

```bash
# ç­‰å¾… GPS åˆå§‹åŒ– (çº¦ 3-5 ç§’)
sleep 5

# å‘é€ç›®æ ‡ç‚¹ï¼š100m å‘ä¸œ
ros2 topic pub /planning/goal geometry_msgs/PoseStamped \
  "{header: {frame_id: 'world'}, pose: {position: {x: 100.0, y: 0.0, z: 0.0}, orientation: {w: 1.0}}}" --once

# è§‚å¯Ÿèˆ¹çš„è¡Œä¸ºï¼ˆ3-5 ç§’ï¼‰
sleep 3

# æŸ¥çœ‹ç›®æ ‡è·ç¦»ï¼ˆåº”è¯¥åœ¨å‡å°ï¼‰
ros2 topic echo /planning/path | head -20
```

### ç¬¬ 6 æ­¥ï¼šå…³é”®è§‚å¯Ÿç‚¹

#### è§‚å¯Ÿ 1ï¼šé¿éšœæ˜¯å¦æ­£å¸¸è§¦å‘ï¼Ÿ

```bash
# åœ¨ç»ˆç«¯3è¿è¡Œï¼Œç›‘çœ‹æ¿€å…‰æ£€æµ‹
ros2 topic echo /wamv/sensors/lidars/lidar_wamv_sensor/scan | head -20

# è§‚å¯Ÿ range æ•°ç»„ä¸­çš„æœ€å°å€¼
# å¦‚æœæœ‰å€¼ < 8.0ï¼Œè¯´æ˜æ£€æµ‹åˆ°éšœç¢ç‰©
```

#### è§‚å¯Ÿ 2ï¼šé¿éšœåæ˜¯å¦æ¢å¤å¯¼èˆªï¼Ÿ

```bash
# åœ¨ç»ˆç«¯3è¿è¡Œï¼Œç›‘çœ‹æ¨è¿›å™¨å‘½ä»¤
watch -n 0.2 'ros2 topic echo -n 1 /wamv/thrusters/left/thrust | grep data'

# é¢„æœŸè¡Œä¸ºï¼š
# æ­£å¸¸èˆªè¡Œ: left_thrust â‰ˆ 400, right_thrust â‰ˆ 400
# é¿éšœæ—¶:   left_thrust â‰ˆ 200, right_thrust â‰ˆ 600 (å·®å¼‚å¤§ï¼Œè½¬å‘)
# é¿å¼€å:   left_thrust â‰ˆ 350, right_thrust â‰ˆ 450 (æ¢å¤æœå‘ç›®æ ‡)
```

#### è§‚å¯Ÿ 3ï¼šç›®æ ‡è·ç¦»æ˜¯å¦æŒç»­å‡å°ï¼Ÿ

```bash
# åœ¨ç»ˆç«¯3è¿è¡Œï¼Œç›‘çœ‹ç›®æ ‡è·ç¦»
ros2 topic echo /planning/path 2>/dev/null | grep -E "position:|x:|y:" | head -30

# æœŸæœ›ï¼šè·ç¦»ä» 100m é€æ­¥å‡å°
# 100 â†’ 95 â†’ 90 â†’ 85 ... â†’ 0 (åˆ°è¾¾ç›®æ ‡)

# é—®é¢˜æŒ‡æ ‡ï¼ˆéœ€è¦æ”¹è¿›ï¼‰ï¼š
# è·ç¦»åœæ­¢å˜åŒ–ï¼ˆå¦‚å§‹ç»ˆå¡åœ¨ 50mï¼‰â†’ é—®é¢˜æœªè§£å†³
```

---

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

âœ… **ä¿®å¤æˆåŠŸçš„æ ‡å¿—ï¼š**

```
â–¡ full_clear_distance å‚æ•°å·²æ”¹ä¸º 20.0
â–¡ ç³»ç»Ÿç¼–è¯‘æ— é”™è¯¯
â–¡ å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹æˆåŠŸ
â–¡ å‘é€ç›®æ ‡ç‚¹åï¼Œèˆ¹æœå‘ç›®æ ‡ç§»åŠ¨
â–¡ é‡åˆ°éšœç¢ç‰©æ—¶ç«‹å³è½¬å‘é¿å¼€
â–¡ é¿å¼€åç«‹å³æ¢å¤æœå‘ç›®æ ‡
â–¡ ç›®æ ‡è·ç¦»æŒç»­å‡å°åˆ° 0
```

âŒ **å¦‚æœè¿˜æœ‰é—®é¢˜ï¼š**

```
å¦‚æœè·ç¦»å¡ä½ï¼ˆä¸ç»§ç»­å‡å°ï¼‰ï¼š
1. æ£€æŸ¥ full_clear_distance æ˜¯å¦çœŸçš„æ”¹æˆ 20.0
   ros2 param get /all_in_one_stack full_clear_distance

2. æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦è¿˜æœ‰ "Force avoidance active" æ—¥å¿—
   ros2 launch control all_in_one_bringup.launch.py 2>&1 | grep -i "avoid\|goal"

3. å¦‚æœè¿˜å¡ä½ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥çš„ä»£ç è°ƒæ•´
   ï¼ˆè§ä¸‹é¢çš„"è¿›é˜¶è°ƒæ•´"éƒ¨åˆ†ï¼‰
```

---

## ğŸ” æ·±å…¥ç†è§£ä¿®å¤åŸç†

### ä¿®å¤å‰çš„æƒ…å†µ

```python
# æ¿€å…‰æ•°æ®ï¼ˆå…¸å‹ï¼‰
front_min = 25.0  # å‰æ–¹ 25mï¼ˆæ— éšœç¢ï¼‰
left_min = 30.0   # å·¦æ–¹ 30mï¼ˆæ‰«æèŒƒå›´æœ«ç«¯ï¼‰
right_min = 30.0  # å³æ–¹ 30mï¼ˆæ‰«æèŒƒå›´æœ«ç«¯ï¼‰

# åŸå§‹ä»£ç åˆ¤æ–­ï¼ˆfull_clear_distance = 60.0ï¼‰
f_val = 25.0 < 60.0 â†’ True    âœ“ æ¿€æ´»é¿éšœ
l_val = 30.0 < 60.0 â†’ True    âœ“ ä¿æŒé¿éšœ
r_val = 30.0 < 60.0 â†’ True    âœ“ ä¿æŒé¿éšœ

force_avoid_active = True  â† è¢«å¡ä½äº†ï¼

å³ä½¿é¿å¼€äº†éšœç¢ç‰©ï¼Œå› ä¸ºæ¿€å…‰èŒƒå›´é™åˆ¶ï¼Œ
é¿éšœæ¨¡å¼æ°¸è¿œæ— æ³•é€€å‡ºã€‚
```

### ä¿®å¤åçš„æƒ…å†µ

```python
# åŒæ ·çš„æ¿€å…‰æ•°æ®
front_min = 25.0
left_min = 30.0
right_min = 30.0

# æ–°ä»£ç åˆ¤æ–­ï¼ˆfull_clear_distance = 20.0ï¼‰
f_val = 25.0 < 20.0 â†’ False   âœ“ ä¸æ¿€æ´»
l_val = 30.0 < 20.0 â†’ False   âœ“ ä¸æ¿€æ´»
r_val = 30.0 < 20.0 â†’ False   âœ“ ä¸æ¿€æ´»

force_avoid_active = False  â† æ­£å¸¸ï¼

ç°åœ¨é¿éšœæ¨¡å¼å¯ä»¥æ­£å¸¸å·¥ä½œï¼š
- å½“æœ‰çœŸå®éšœç¢ç‰©æ—¶ (< 20m) æ¿€æ´»é¿éšœ
- å½“éšœç¢ç‰©è¿œå»æ—¶ (> 20m) é€€å‡ºé¿éšœ
- æ¨åŠ›æ¢å¤åˆ°æ­£å¸¸å€¼ (400N)
- æœå‘ç›®æ ‡å¯¼èˆªæ¢å¤æ­£å¸¸
```

---

## ğŸ“Š å‚æ•°è°ƒæ•´è®°å½•

| å‚æ•° | æ—§å€¼ | æ–°å€¼ | åŸå›  |
|------|------|------|------|
| `full_clear_distance` | 60.0 âŒ | 20.0 âœ… | æ¿€å…‰èŒƒå›´é™åˆ¶å¯¼è‡´å¡ä½ |

---

## ğŸš€ åç»­å¯é€‰ä¼˜åŒ–

å¦‚æœä¿®å¤åè¿˜æƒ³è¿›ä¸€æ­¥æ”¹è¿›ï¼Œå¯ä»¥è€ƒè™‘ï¼š

### å¯é€‰ä¼˜åŒ– 1ï¼šå¾®è°ƒé¿éšœè·ç¦»

```python
'obstacle_slow_dist': 12.0  â†’ 10.0   # æ›´æ¿€è¿›çš„é¿éšœ
'obstacle_stop_dist': 6.0   â†’ 5.0    # æ›´æ—©å¼€å§‹æ¢å¤
```

### å¯é€‰ä¼˜åŒ– 2ï¼šå¢åŠ å¯¼èˆªæ¨åŠ›

```python
'forward_thrust': 400.0  â†’ 450.0   # æ›´å¼ºçš„å‰è¿›é©±åŠ¨
'kp_yaw': 600.0          â†’ 700.0   # æ›´å¿«çš„è½¬å‘å“åº”
```

### å¯é€‰ä¼˜åŒ– 3ï¼šæ”¹è¿›æ··åˆé¿éšœç­–ç•¥ï¼ˆé«˜çº§ï¼‰

å¦‚æœéœ€è¦åŒæ—¶ä¼˜åŒ–é¿éšœå’Œå¯¼èˆªï¼Œå¯ä»¥ä¿®æ”¹ä»£ç ä¸­çš„æåæ ‡ç›´æ–¹å›¾æƒé‡
ï¼ˆè§ `AVOIDANCE_ISSUE_ROOT_CAUSE.md` æ–¹æ¡ˆ Cï¼‰

---

## âœ”ï¸ å®Œæˆæ¸…å•

å®æ–½ä¿®å¤æ—¶ï¼Œæ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

```
â–¡ ä¿®æ”¹äº† full_clear_distance: 60.0 â†’ 20.0
â–¡ ä¿å­˜äº† all_in_one_bringup.launch.py
â–¡ ç¼–è¯‘äº†å·¥ä½œç©ºé—´ (colcon build)
â–¡ å¯åŠ¨äº†ç³»ç»Ÿ
â–¡ éªŒè¯äº†å‚æ•°å€¼ (ros2 param get)
â–¡ è¿è¡Œäº†é¿éšœæµ‹è¯•
â–¡ è§‚å¯Ÿäº†èˆ¹çš„è¡Œä¸ºæ˜¯å¦æ”¹å–„
â–¡ ï¼ˆå¯é€‰ï¼‰æäº¤äº†ä¿®æ”¹åˆ° git
```

---

## ğŸ’¡ å…³é”®ç»éªŒ

è¿™ä¸ªé—®é¢˜çš„æ·±å±‚æ•™è®­ï¼š

```
1. å‚æ•°éœ€è¦ä¸ç¡¬ä»¶è§„æ ¼åŒ¹é…
   â””â”€ full_clear_distance (60m) è¶…è¿‡äº†æ¿€å…‰é›·è¾¾èŒƒå›´ (30m)

2. é¿éšœå’Œå¯¼èˆªæ˜¯ä¸¤ä¸ªä¸åŒçš„ç›®æ ‡
   â””â”€ éœ€è¦ç²¾å¿ƒè®¾è®¡å®ƒä»¬çš„äº¤äº’

3. åœ¨å‚æ•°ç©ºé—´ä¸­å¾ˆå®¹æ˜“å‡ºç°"é™·é˜±"
   â””â”€ æŸä¸ªå‚æ•°å€¼ä¼šå¯¼è‡´ä¸é¢„æœŸçš„è¡Œä¸º

4. è°ƒè¯•å¤æ‚ç³»ç»Ÿæ—¶ï¼Œå…³é”®æ˜¯ç†è§£çŠ¶æ€æœº
   â””â”€ force_avoid_active çš„æ¿€æ´»/é€€å‡ºæ¡ä»¶æ˜¯å…³é”®
```

---

## ğŸ“ æ”¯æŒ

å¦‚æœä¿®å¤åè¿˜æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **å‚æ•°ç¡®å®æ”¹äº†å—ï¼Ÿ**
   ```bash
   ros2 param get /all_in_one_stack full_clear_distance
   ```

2. **æ—¥å¿—æ˜¾ç¤ºä»€ä¹ˆï¼Ÿ**
   ```bash
   ros2 launch control all_in_one_bringup.launch.py 2>&1 | tail -50
   ```

3. **æ¿€å…‰é›·è¾¾å·¥ä½œå—ï¼Ÿ**
   ```bash
   ros2 topic hz /wamv/sensors/lidars/lidar_wamv_sensor/scan
   ```

4. **æ¨è¿›å™¨æ”¶åˆ°å‘½ä»¤å—ï¼Ÿ**
   ```bash
   ros2 topic echo /wamv/thrusters/left/thrust
   ```

å¦‚æœè¿˜æ˜¯ä¸è¡Œï¼Œä¸‹ä¸€æ­¥å¯ä»¥å®æ–½ä»£ç çº§åˆ«çš„è°ƒæ•´ï¼ˆæ–¹æ¡ˆ B æˆ– Cï¼‰ã€‚

