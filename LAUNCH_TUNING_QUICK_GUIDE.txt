#!/usr/bin/env python3
"""
Quick Launch Parameter Tuning Guide
Edit: control/launch/all_in_one_bringup.launch.py (lines 60-104)
"""

# ============================================================================
# THRUST CONTROL - Lines 60-62
# ============================================================================
'forward_thrust': 400.0,           # Increase → faster, Decrease → slower
'kp_yaw': 600.0,                   # Increase → sharper turns, Decrease → smoother
'control_rate': 20.0,              # Increase → more responsive (but CPU intensive)

# TIP: If oscillating, decrease kp_yaw. If too slow, increase forward_thrust.

# ============================================================================
# WAYPOINT TRACKING - Lines 65-69
# ============================================================================
'waypoint_tolerance': 3.0,         # Increase → looser, Decrease → tighter
'goal_tolerance': 1.0,             # Increase → stops far away, Decrease → stops closer
'approach_slow_dist': 10.0,        # Increase → slows down earlier, Decrease → later
'heading_align_thresh_deg': 20.0,  # Increase → waits longer before full speed
'overshoot_margin': 1.0,           # Increase → allows more overshoot before stopping

# TIP: If overshooting goal, decrease approach_slow_dist or goal_tolerance.

# ============================================================================
# OBSTACLE AVOIDANCE - Lines 72-82
# ============================================================================
'obstacle_slow_dist': 15.0,        # Increase → reacts earlier to obstacles
'obstacle_stop_dist': 8.0,         # Increase → stops farther from obstacles
'avoid_turn_thrust': 350.0,        # Increase → sharper emergency turns
'avoid_diff_gain': 40.0,           # Increase → more aggressive steering
'avoid_clear_margin': 3.0,         # Increase → more safety margin
'avoid_max_turn_time': 5.0,        # Increase → turns longer if needed
'full_clear_distance': 60.0,       # Increase → keeps avoidance active longer
'front_angle_deg': 30.0,           # Wider = detects obstacles earlier
'side_angle_deg': 60.0,            # Wider = better side awareness

# TIP: If hitting obstacles, decrease obstacle_stop_dist or increase avoid_turn_thrust.

# ============================================================================
# STUCK DETECTION & RECOVERY - Lines 85-90
# ============================================================================
'stuck_timeout': 8.0,              # Increase → waits longer before recovery
'stuck_progress_epsilon': 0.1,     # Increase → easier to trigger recovery
'recover_reverse_time': 3.0,       # Increase → reverses longer
'recover_turn_time': 3.0,          # Increase → turns longer in recovery
'recover_reverse_thrust': -200.0,  # Decrease (more negative) → stronger reverse
'recover_reverse_time_long': 6.0,  # Increase → longer reverse when really stuck

# TIP: If false recovery triggers, increase stuck_timeout. If can't escape, increase recover_reverse_thrust (more negative).

# ============================================================================
# QUICK TUNING SCENARIOS
# ============================================================================

# SCENARIO A: High Precision (Landing, Docking)
'forward_thrust': 300.0,
'approach_slow_dist': 15.0,
'goal_tolerance': 0.5,
'waypoint_tolerance': 1.5,
'kp_yaw': 400.0,

# SCENARIO B: Fast Navigation (Open Water)
'forward_thrust': 600.0,
'waypoint_tolerance': 5.0,
'goal_tolerance': 2.0,
'kp_yaw': 800.0,
'control_rate': 30.0,

# SCENARIO C: Dense Obstacles (or Low/High Obstacles like Docks)
'obstacle_slow_dist': 20.0,
'obstacle_stop_dist': 5.0,
'avoid_diff_gain': 60.0,
'avoid_turn_thrust': 450.0,
'stuck_timeout': 5.0,
'cloud_z_min': -2.0,  # Detect obstacles below waterline
'cloud_z_max': 3.0,   # Detect tall obstacles (docks, structures)

# SCENARIO D: Open Area
'obstacle_slow_dist': 30.0,
'obstacle_stop_dist': 15.0,
'forward_thrust': 700.0,
'stuck_timeout': 15.0,

# ============================================================================
# HOW TO TEST
# ============================================================================

# Step 1: Send a goal
# ros2 topic pub -1 /planning/goal geometry_msgs/msg/PoseStamped \
#   '{header: {frame_id: world}, pose: {position: {x: 50.0, y: 50.0, z: 0.0}, orientation: {w: 1.0}}}'

# Step 2: View parameters
# ros2 param list /all_in_one_stack
# ros2 param get /all_in_one_stack forward_thrust

# Step 3: Dynamic tuning (no restart needed)
# ros2 param set /all_in_one_stack forward_thrust 500.0
# ros2 param set /all_in_one_stack goal_tolerance 0.5

# Step 4: Monitor logs
# ros2 launch control all_in_one_bringup.launch.py 2>&1 | grep -E "Obstacle|Stuck|Waypoint"

# ============================================================================
# PARAMETER RANGES (Safe Limits)
# ============================================================================

forward_thrust = (100, 1000)           # Newton
kp_yaw = (100, 1000)                   # proportional gain
waypoint_tolerance = (0.5, 10.0)       # meters
goal_tolerance = (0.3, 3.0)            # meters
approach_slow_dist = (5, 30)           # meters
obstacle_slow_dist = (8, 30)           # meters
obstacle_stop_dist = (3, 15)           # meters
stuck_timeout = (3, 20)                # seconds
recover_reverse_thrust = (-500, -50)   # Newton (negative)

# ============================================================================
# COMMON ISSUES & FIXES
# ============================================================================

ISSUE: Lidar can't detect dock/obstacles
FIX: Adjust cloud_z_min and cloud_z_max
     - If dock is LOW: Decrease cloud_z_min (e.g., -2.0, -3.0)
     - If dock is HIGH: Increase cloud_z_max (e.g., 3.0, 4.0)
     - For very low docks: Set cloud_z_min to -3.0 or even lower

ISSUE: Boat won't reach goal
FIX: Decrease goal_tolerance, increase forward_thrust

ISSUE: Boat overshoots goal
FIX: Decrease approach_slow_dist or goal_tolerance, decrease forward_thrust

ISSUE: Oscillates around heading
FIX: Decrease kp_yaw

ISSUE: Doesn't respond to obstacles
FIX: Decrease obstacle_slow_dist, increase avoid_diff_gain

ISSUE: False stuck detection
FIX: Increase stuck_timeout

ISSUE: Can't escape obstacles
FIX: Increase recover_reverse_thrust (more negative), increase recover_reverse_time_long

ISSUE: Turns too slowly
FIX: Increase kp_yaw, increase control_rate, increase avoid_turn_thrust

# ============================================================================
# WORKFLOW
# ============================================================================

1. Copy default launch file
   cp all_in_one_bringup.launch.py all_in_one_bringup_test.launch.py

2. Edit one parameter at a time
   vim all_in_one_bringup_test.launch.py

3. Test in open area first
   ros2 launch control all_in_one_bringup_test.launch.py

4. Send goal multiple times
   ros2 topic pub -1 /planning/goal geometry_msgs/msg/PoseStamped \
     '{header: {frame_id: world}, pose: {position: {x: 30.0, y: 30.0}, orientation: {w: 1.0}}}'

5. Record performance (time, accuracy, smoothness)

6. Adjust parameters based on results

7. Save best configuration
   cp all_in_one_bringup_test.launch.py all_in_one_bringup_optimized.launch.py

# ============================================================================
# KEY PARAMETERS TO START WITH
# ============================================================================

Priority 1 (Most Important):
  - forward_thrust: Controls speed
  - goal_tolerance: Controls stopping accuracy
  - obstacle_stop_dist: Controls safety

Priority 2 (Fine-tuning):
  - kp_yaw: Controls heading smoothness
  - approach_slow_dist: Controls approach behavior
  - stuck_timeout: Controls recovery sensitivity

Priority 3 (Advanced):
  - avoid_diff_gain: Controls avoidance aggressiveness
  - vfh_bin_deg: Controls direction planning precision
  - recover_reverse_thrust: Controls emergency power

