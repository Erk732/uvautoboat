# ============================================================================
# ATLANTIS - Modular Navigation System
# Lawnmower Pattern Scanning for Environmental Monitoring
# ============================================================================
#
# Launches the Atlantis modular navigation stack:
#   - atlantis_planner (plan package) - Lawnmower path generation
#   - atlantis_controller (control package) - PID control with obstacle avoidance
#
# Prerequisites:
#   # Kill any old Gazebo processes (Optional but recommended)
#   pkill -9 gz && pkill -9 ruby
#
#   # Build workspace (If the package is not yet built or after changes)
#   cd ~/seal_ws && colcon build --merge-install && source install/setup.bash
#
# Usage (4 terminals):
#   T1: ros2 launch vrx_gz competition.launch.py world:=sydney_regatta (or any other world you create)
#   T2: ros2 launch rosbridge_server rosbridge_websocket_launch.xml delay_between_messages:=0.0
#   T3: ros2 launch ~/seal_ws/src/uvautoboat/launch/atlantis.launch.yaml
#   T4: cd ~/seal_ws/src/uvautoboat/web_dashboard/atlantis && python3 -m http.server 8080
#
# Then open: http://localhost:8080
#
# ============================================================================

launch:

# ============================================================================
# ATLANTIS PLANNER - Lawnmower Path Generation
# ============================================================================
- node:
    pkg: plan
    exec: atlantis_planner
    name: atlantis_planner
    output: screen
    param:
    # Scan Pattern Parameters
    - name: scan_length
      value: 150.0      # Length of each scanning lane (m)
    - name: scan_width
      value: 20.0       # Spacing between lanes (m)
    - name: lanes
      value: 4          # Number of scanning lanes
    - name: frame_id
      value: "map"      # Coordinate frame for path

# ============================================================================
# ATLANTIS CONTROLLER - PID Control with Obstacle Avoidance
# ============================================================================
- node:
    pkg: control
    exec: atlantis_controller
    name: atlantis_controller
    output: screen
    param:
    # PID Gains
    - name: kp
      value: 400.0
    - name: ki
      value: 20.0
    - name: kd
      value: 100.0
    # Speed Settings
    - name: base_speed
      value: 500.0      # Normal cruising thrust (N)
    - name: max_speed
      value: 800.0      # Maximum thrust limit (N)
    - name: waypoint_tolerance
      value: 2.0        # Distance to consider waypoint reached (m)
    # Obstacle Avoidance
    - name: min_safe_distance
      value: 8.0        # Start slowing down distance (m)
    - name: critical_distance
      value: 2.0        # Emergency stop distance (m)
    - name: obstacle_slow_factor
      value: 0.1        # Speed reduction factor near obstacles
    - name: hysteresis_distance
      value: 1.0        # Hysteresis to prevent mode oscillation (m)
    - name: reverse_timeout
      value: 10.0       # Max time to reverse when stuck (s)
    # Smart Anti-Stuck System (SASS)
    - name: stuck_timeout
      value: 5.0        # Time before declaring stuck (s)
    - name: stuck_threshold
      value: 1.0        # Movement threshold for stuck detection (m)
    - name: no_go_zone_radius
      value: 8.0        # Radius of no-go zones around failed positions (m)
    - name: drift_compensation_gain
      value: 0.3        # Gain for drift compensation
    - name: probe_angle
      value: 45.0       # Angle for directional probing (degrees)
    - name: detour_distance
      value: 12.0       # Distance for detour maneuvers (m)

# Add standalone OKO perception so Atlantis can use shared perception node
- node:
    pkg: plan
    exec: oko_perception
    name: oko_perception_node
    output: screen
    param:
    - name: min_safe_distance
      value: 12.0
    - name: critical_distance
      value: 4.0
    - name: min_height
      value: -15.0
    - name: max_height
      value: 10.0
    - name: min_range
      value: 3.0
    - name: max_range
      value: 60.0
