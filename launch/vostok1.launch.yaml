# ============================================================================
# PROJET-17 — Vostok1 Modular Navigation System
# ============================================================================
#
# Launches the modular Vostok1-based navigation system:
#   - oko_perception (OKO) - 3D LIDAR obstacle detection
#   - sputnik_planner (SPUTNIK) - GPS waypoint planning
#   - buran_controller (BURAN) - PID control with obstacle avoidance
#
# Prerequisites:
#   # Kill any old Gazebo processes (Optional but recommended)
#   pkill -9 gz && pkill -9 ruby
#
#   # Build workspace (If the package is not yet built or after changes)
#   cd ~/seal_ws && colcon build --merge-install && source install/setup.bash
#
# Usage (multi-terminal) - IMPORTANT: Follow timing order!
#
#   T1: Gazebo (VRX): ros2 launch vrx_gz competition.launch.py world:=sydney_regatta_smoke_wildlife
#       Wait 15–20s for physics to start.
#
#   T2: Rosbridge (for web dashboard): ros2 launch rosbridge_server rosbridge_websocket_launch.xml delay_between_messages:=0.0
#       Wait 2–3s for rosbridge to initialize.
#
#   T3: Navigation stack (this file): ros2 launch ~/seal_ws/src/uvautoboat/launch/vostok1.launch.yaml
#       Wait ~5s for OKO/SPUTNIK/BURAN to initialize.
#
#   T4: Web video server (camera stream for dashboard):
#       Install once if missing: sudo apt install ros-${ROS_DISTRO}-web-video-server
#       Run: ros2 run web_video_server web_video_server   # defaults to http://localhost:8080
#
#   T5: RViz (optional visualization): ros2 launch vrx_gz rviz.launch.py
#
#   T6: Web dashboard: cd ~/seal_ws/src/uvautoboat/web_dashboard/vostok1 && python3 -m http.server 8000
#       Browser: open http://localhost:8000 (wait for GPS to publish first fix)
#
# NOTE: GPS can take 10–30s to initialize in VRX. If the dashboard shows "waiting for GPS",
#       wait longer or check with: ros2 topic echo /wamv/sensors/gps/gps/fix --once
#
# Supported worlds:
#   - sydney_regatta_smoke_wildlife ✓ GPS working (recommended)
#   - sydney_regatta_smoke ✓ GPS working
#   - sydney_regatta_DEFAULT ✓ GPS working, for cleaner testing
#
# ============================================================================

launch:

# ============================================================================
# OKO - Perception Node (3D LIDAR Processing)
# Tuned for lake bank and harbour detection
# Height reference: LiDAR mounted ~2-3m above water
#   - Water surface:     Z ≈ -3m (below LiDAR)
#   - Lake bank/terrain: Z ≈ -2.5m (below LiDAR)
#   - Concrete harbour:  Z ≈ -1 to -0.5m (below LiDAR)
#   - Obstacles on dock: Z ≈ 0 to +2m
# ============================================================================
- node:
    pkg: plan
    exec: oko_perception
    name: oko_perception_node
    output: screen
    param:
    - name: min_safe_distance
      value: 10.0       # Moderately conservative
    - name: critical_distance
      value: 5.5        # Emergency stop threshold
    - name: hysteresis_distance
      value: 2.0        # More slack to avoid chatter
    - name: min_height
      value: -1.2       # Keep more low returns
    - name: max_height
      value: 2.0        # Focus on pier/boat geometry, ignore tall clutter
    - name: min_range
      value: 2.2        # Keep closer returns, still filter hull
    - name: max_range
      value: 75.0       # Full sensor useful range
    - name: sample_rate
      value: 1          # Process ALL points for maximum detection
    # Enhanced OKO v2.0 parameters (tuned for faster response)
    - name: temporal_history_size
      value: 3          # Reduced: faster response
    - name: temporal_threshold
      value: 2          # Require 2/3 detections to confirm
    - name: cluster_distance
      value: 2.5        # Max distance between cluster points (m) - tuned for 3D LiDAR
    - name: min_cluster_size
      value: 6          # Allow smaller clusters
    - name: water_plane_threshold
      value: 0.32       # Balance water rejection vs dropouts
    - name: velocity_history_size
      value: 5          # Frames for velocity estimation (v2.0: detect moving obstacles)

# ============================================================================
# SPUTNIK - Planner Node (GPS Waypoint Navigation)
# ============================================================================
- node:
    pkg: plan
    exec: sputnik_planner
    name: sputnik_planner_node
    output: screen
    param:
    - name: scan_length
      value: 15.0
    - name: scan_width
      value: 30.0
    - name: lanes
      value: 10
    - name: waypoint_tolerance
      value: 1.0        # Stricter tolerance for waypoint completion
    - name: waypoint_skip_timeout
      value: 45.0       # Allow more time to clear obstacles before skipping
    # Hazard Zone Avoidance (v2.1)
    - name: hazard_enabled
      value: false      # Disabled by default (enable via CLI/param if needed)
    - name: hazard_origin_world_x
      value: -530.6717  # World frame origin X coordinate
    - name: hazard_origin_world_y
      value: 161.6251   # World frame origin Y coordinate
    - name: plan_avoid_margin
      value: 5.0        # Detour margin (m) around hazard boxes
    - name: hull_radius
      value: 1.5        # Boat hull radius for clearance (m)
    # A* Detour Planning (v2.2)
    - name: astar_enabled
      value: true       # Runtime A* detours when waypoints blocked
    - name: astar_hybrid_mode
      value: false      # Pre-plan A* routes between lawnmower waypoints
    - name: astar_resolution
      value: 3.0        # Grid resolution for A* (m)
    - name: astar_safety_margin
      value: 12.0       # Safety margin around obstacles (m)
    - name: astar_max_expansions
      value: 20000      # Max node expansions for A* search
    - name: hazard_world_boxes
      value: "795.0,-325.0,925.0,-315.0;935.0,-325.0,1205.0,-315.0;655.0,-315.0,675.0,-305.0;765.0,-315.0,1205.0,-305.0;-15.0,-305.0,5.0,-295.0;535.0,-305.0,555.0,-295.0;645.0,-305.0,675.0,-295.0;735.0,-305.0,1215.0,-295.0;-25.0,-295.0,65.0,-285.0;285.0,-295.0,315.0,-285.0;525.0,-295.0,565.0,-285.0;625.0,-295.0,685.0,-285.0;725.0,-295.0,1215.0,-285.0;-25.0,-285.0,145.0,-275.0;275.0,-285.0,345.0,-275.0;415.0,-285.0,445.0,-275.0;515.0,-285.0,575.0,-275.0;615.0,-285.0,685.0,-275.0;705.0,-285.0,1225.0,-275.0;835.0,-345.0,865.0,-335.0;1005.0,-345.0,1065.0,-335.0;1145.0,-345.0,1165.0,-335.0;805.0,-335.0,895.0,-325.0;995.0,-335.0,1185.0,-325.0;-35.0,-275.0,155.0,-265.0;265.0,-275.0,585.0,-265.0;605.0,-275.0,1245.0,-265.0;-75.0,-265.0,175.0,-255.0;255.0,-265.0,1265.0,-255.0;-215.0,-255.0,185.0,-245.0;215.0,-255.0,1265.0,-245.0;-365.0,-245.0,-335.0,-235.0;-225.0,-245.0,1275.0,-235.0;-455.0,-235.0,-295.0,-225.0;-245.0,-235.0,1275.0,-225.0;-475.0,-225.0,1285.0,-215.0;-655.0,-215.0,-605.0,-205.0;-495.0,-215.0,1285.0,-205.0;-705.0,-205.0,1295.0,-195.0;-1015.0,-195.0,-995.0,-185.0;-885.0,-195.0,-855.0,-185.0;-755.0,-195.0,1295.0,-185.0;-1015.0,-185.0,-985.0,-175.0"

# ============================================================================
# BURAN - Controller Node (PID Control with Obstacle Avoidance)
# ============================================================================
- node:
    pkg: control
    exec: buran_controller
    name: buran_controller_node
    output: screen
    param:
    # PID Gains
    - name: kp
      value: 500.0       # Tighter heading control
    - name: ki
      value: 20.0
    - name: kd
      value: 150.0       # More damping to reduce overshoot
    # Speed Settings
    - name: base_speed
      value: 400.0      # Slower base for tighter waypoint tracking
    - name: max_speed
      value: 800.0      # Proven stable thrust for VRX
    # Obstacle Avoidance
    - name: obstacle_slow_factor
      value: 0.5        # Strong slowdown
    - name: critical_distance
      value: 6.0        # Hard-stop threshold
    - name: reverse_timeout
      value: 4.0
    # Approach slowdown (precision near waypoints)
    - name: approach_slow_distance
      value: 8.0        # Begin slowing within 8m of waypoint
    - name: approach_slow_factor
      value: 0.6        # Scale speed when inside slow distance
    # Smart Anti-Stuck System (SASS)
    - name: stuck_timeout
      value: 6.0          # Wait longer before declaring stuck
    - name: stuck_threshold
      value: 1.0          # Require more lack of progress
    - name: no_go_zone_radius
      value: 10.0         # Larger keep-out after stuck
    - name: detour_distance
      value: 8.0          # Shorter detours for milder escape
    - name: drift_compensation_gain
      value: 0.3          # Compensation gain for estimated drift/current
    - name: kalman_process_noise
      value: 0.01         # Kalman filter process noise (drift estimator)
    - name: kalman_measurement_noise
      value: 0.5          # Kalman filter measurement noise (drift estimator)
    # BURAN v2.1 Enhanced Control
    - name: dead_zone_threshold
      value: 0.5          # Dead zone for minor thrust adjustments
    - name: avoid_diff_gain
      value: 18.0         # Very mild differential steering
    - name: use_vfh_bias
      value: false        # Disable VFH/polar steering bias by default
