# ============================================================================
# PROJET-17 — Vostok1 Modular Navigation System
# ============================================================================
#
# Launches the modular Vostok1-based navigation system:
#   - oko_perception (OKO) - 3D LIDAR obstacle detection
#   - sputnik_planner (SPUTNIK) - GPS waypoint planning
#   - buran_controller (BURAN) - PID control with obstacle avoidance
#
# Prerequisites:
#   # Kill any old Gazebo processes (Optional but recommended)
#   pkill -9 gz && pkill -9 ruby
#
#   # Build workspace (If the package is not yet built or after changes)
#   cd ~/seal_ws && colcon build --merge-install && source install/setup.bash
#
# Usage (multi-terminal) - IMPORTANT: Follow timing order!
#
#   T1: Gazebo (VRX): ros2 launch vrx_gz competition.launch.py world:=sydney_regatta_smoke_wildlife
#       Wait 15–20s for physics to start.
#
#   T2: Rosbridge (for web dashboard): ros2 launch rosbridge_server rosbridge_websocket_launch.xml delay_between_messages:=0.0
#       Wait 2–3s for rosbridge to initialize.
#
#   T3: Navigation stack (this file): ros2 launch ~/seal_ws/src/uvautoboat/launch/vostok1.launch.yaml
#       Wait ~5s for OKO/SPUTNIK/BURAN to initialize.
#
#   T4: Web video server (camera stream for dashboard):
#       Install once if missing: sudo apt install ros-${ROS_DISTRO}-web-video-server
#       Run: ros2 run web_video_server web_video_server   # defaults to http://localhost:8080
#
#   T5: RViz (optional visualization): ros2 launch vrx_gz rviz.launch.py
#
#   T6: Web dashboard: cd ~/seal_ws/src/uvautoboat/web_dashboard/vostok1 && python3 -m http.server 8000
#       Browser: open http://localhost:8000 (wait for GPS to publish first fix)
#
# NOTE: GPS can take 10–30s to initialize in VRX. If the dashboard shows "waiting for GPS",
#       wait longer or check with: ros2 topic echo /wamv/sensors/gps/gps/fix --once
#
# Supported worlds:
#   - sydney_regatta_smoke_wildlife ✓ GPS working (recommended)
#   - sydney_regatta_smoke ✓ GPS working
#   - sydney_regatta_DEFAULT ✓ GPS working, for cleaner testing
#
# ============================================================================

launch:

# ============================================================================
# OKO - Perception Node (3D LIDAR Processing)
# Tuned for lake bank and harbour detection
# Height reference: LiDAR mounted ~2-3m above water
#   - Water surface:     Z ≈ -3m (below LiDAR)
#   - Lake bank/terrain: Z ≈ -2.5m (below LiDAR)
#   - Concrete harbour:  Z ≈ -1 to -0.5m (below LiDAR)
#   - Obstacles on dock: Z ≈ 0 to +2m
# ============================================================================
- node:
    pkg: plan
    exec: oko_perception
    name: oko_perception_node
    output: screen
    param:
    - name: min_safe_distance
      value: 10.0       # Moderately conservative
    - name: critical_distance
      value: 5.5        # Emergency stop threshold
    - name: hysteresis_distance
      value: 2.0        # More slack to avoid chatter
    - name: min_height
      value: -1.2       # Lower threshold to detect low piers (LiDAR@1.8m: piers≈-1.0 to -0.3m)
    - name: max_height
      value: 1.5        # Focus on navigation hazards, ignore tall structures
    - name: min_range
      value: 2.2        # Keep closer returns, still filter hull
    - name: max_range
      value: 100.0      # Extended range for early detection (LiDAR max: 130m)
    - name: sample_rate
      value: 1          # Process ALL points (30k points/scan optimal for detection)
    # Enhanced OKO v2.0 parameters (tuned for faster response)
    - name: temporal_history_size
      value: 3          # Reduced: faster response
    - name: temporal_threshold
      value: 2          # Require 2/3 detections to confirm
    - name: cluster_distance
      value: 3.0        # Cluster tolerance for high-density LiDAR (1875×16 samples)
    - name: min_cluster_size
      value: 8          # Require more points due to higher point density
    - name: water_plane_threshold
      value: 0.32       # Balance water rejection vs dropouts
    - name: velocity_history_size
      value: 5          # Frames for velocity estimation (v2.0: detect moving obstacles)
    # Smoke filtering (v2.1) - Tuned for sydney_regatta_smoke.sdf particle properties
    - name: smoke_filter_enabled
      value: true       # Enable smoke filtering (prevents smoke from being counted as obstacles)
    - name: smoke_min_height
      value: 0.3        # Catch smoke near water surface (SDF: emitters at 0.5m)
    - name: smoke_max_height
      value: 10.0       # Extended: smoke rises 3-8m with 0.15-0.35m/s velocity
    - name: solid_min_height
      value: -2.0       # Solid obstacles below water line
    - name: solid_max_height
      value: 0.5        # Solid obstacles at/near water surface
    # Smoke detection (v2.2) - Active LiDAR-based smoke detection
    - name: smoke_detection_enabled
      value: true       # Enable smoke detection (reports smoke location/density)
    - name: smoke_min_cluster_size
      value: 50         # Min LiDAR points to confirm smoke presence
    - name: smoke_detection_range
      value: 50.0       # Max range to detect smoke (m)

# ============================================================================
# SPUTNIK - Planner Node (GPS Waypoint Navigation)
# ============================================================================
- node:
    pkg: plan
    exec: sputnik_planner
    name: sputnik_planner_node
    output: screen
    param:
    - name: scan_length
      value: 15.0
    - name: scan_width
      value: 30.0
    - name: lanes
      value: 10
    - name: waypoint_tolerance
      value: 3.5        # Increased from 1.0 for easier waypoint capture (avoid circling)
    - name: waypoint_skip_timeout
      value: 45.0       # Allow more time to clear obstacles before skipping
    # Hazard Zone Avoidance (v2.1)
    - name: hazard_enabled
      value: false      # Disabled by default (enable via CLI/param if needed)
    - name: hazard_origin_world_x
      value: -532.0     # World frame origin X coordinate (matches competition.launch spawn)
    - name: hazard_origin_world_y
      value: 162.0      # World frame origin Y coordinate (matches competition.launch spawn)
    - name: plan_avoid_margin
      value: 5.0        # Detour margin (m) around hazard boxes
    - name: hull_radius
      value: 1.5        # Boat hull radius for clearance (m)
    # A* Detour Planning (v2.2)
    - name: astar_enabled
      value: true       # Runtime A* detours when waypoints blocked
    - name: astar_hybrid_mode
      value: false      # Pre-plan A* routes between lawnmower waypoints
    - name: astar_resolution
      value: 3.0        # Grid resolution for A* (m)
    - name: astar_safety_margin
      value: 12.0       # Safety margin around obstacles (m)
    - name: astar_max_expansions
      value: 20000      # Max node expansions for A* search
    # Pollutant Source Detection (Smoke Generators in SDF)
    - name: pollutant_scan_enabled
      value: true       # Enable smoke generator scanning
    - name: pollutant_sdf_glob
      value: "/home/ghostzero/seal_ws/src/uvautoboat/test_environment/*smoke*.sdf"  # Absolute path to smoke SDF files
    # Note: hazard_world_boxes removed - not used when hazard_enabled=false (see line 125)

# ============================================================================
# BURAN - Controller Node (PID Control with Obstacle Avoidance)
# ============================================================================
- node:
    pkg: control
    exec: buran_controller
    name: buran_controller_node
    output: screen
    param:
    # PID Gains
    - name: kp
      value: 500.0       # Tighter heading control
    - name: ki
      value: 20.0
    - name: kd
      value: 150.0       # More damping to reduce overshoot
    # Speed Settings
    - name: base_speed
      value: 400.0      # Slower base for tighter waypoint tracking
    - name: max_speed
      value: 800.0      # Proven stable thrust for VRX
    # Obstacle Avoidance
    - name: obstacle_slow_factor
      value: 0.5        # Strong slowdown
    - name: critical_distance
      value: 6.0        # Hard-stop threshold
    - name: reverse_timeout
      value: 4.0
    # Approach slowdown (precision near waypoints)
    - name: approach_slow_distance
      value: 10.0       # Begin slowing within 10m of waypoint (was 8.0)
    - name: approach_slow_factor
      value: 0.7        # Scale speed when inside slow distance (was 0.6, keep more momentum)
    # Simple Anti-Stuck System
    - name: stuck_timeout
      value: 12.0         # Time before declaring stuck (seconds)
    - name: stuck_threshold
      value: 1.0          # Distance threshold in meters
    - name: drift_compensation_gain
      value: 0.3          # Compensation gain for estimated drift/current
    - name: kalman_process_noise
      value: 0.01         # Kalman filter process noise (drift estimator)
    - name: kalman_measurement_noise
      value: 0.5          # Kalman filter measurement noise (drift estimator)
    # BURAN v2.1 Enhanced Control
    - name: dead_zone_threshold
      value: 0.5          # Dead zone for minor thrust adjustments
    - name: avoid_diff_gain
      value: 18.0         # Very mild differential steering
    - name: use_vfh_bias
      value: false        # Disable VFH/polar steering bias by default
    - name: max_avoidance_turn_deg
      value: 20.0         # Maximum obstacle avoidance turn angle (degrees)

# ============================================================================
# Waypoint Visualizer - RViz Visualization (Optional but Recommended)
# Publishes markers for waypoints, path, and boat trajectory for RViz
# Subscribes to modular architecture topics: /planning/mission_status, /planning/waypoints
# ============================================================================
- node:
    pkg: plan
    exec: waypoint_visualizer
    name: waypoint_visualizer_node
    output: screen
